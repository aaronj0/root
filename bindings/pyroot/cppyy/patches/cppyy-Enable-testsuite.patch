From 7eafbaa8ad7a17ac9fe860982bd168c5d3c05589 Mon Sep 17 00:00:00 2001
From: Aaron Jomy <aaronjomyjoseph@gmail.com>
Date: Thu, 27 Mar 2025 11:31:02 +0100
Subject: [PATCH] [cppyy] Drop genreflex in favour of rootcling for test
 dictionaries

This patch modifies upstream cppyy's test suite to use rootcling for
dictionary generation, and also marks all tests that regress or crash
on ROOT. This heavily simplifies the MakeFile, which will be dropped
subsequently in favour of CMake that adds this to ROOTs ctest executable.
---
 bindings/pyroot/cppyy/cppyy/test/Makefile | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

diff --git a/bindings/pyroot/cppyy/cppyy/test/Makefile b/bindings/pyroot/cppyy/cppyy/test/Makefile
index 0d13d38c22..c40442fab0 100644
--- a/bindings/pyroot/cppyy/cppyy/test/Makefile
+++ b/bindings/pyroot/cppyy/cppyy/test/Makefile
@@ -16,20 +16,22 @@ dicts = advancedcppDict.so \
 
 all : $(dicts)
 
-genreflex_flags := $(shell genreflex --cppflags)
-cppflags=$(shell cling-config --cppflags) $(genreflex_flags) -O3 -fPIC -I$(shell python -c 'import sysconfig as sc; print(sc.get_config_var("INCLUDEPY"))') -Wno-register
-
+cppflags=$(shell root-config --cflags) -O3 -fPIC -I$(shell python -c 'import sysconfig as sc; print(sc.get_config_var("INCLUDEPY"))') -Wno-register
 PLATFORM := $(shell uname -s)
 ifeq ($(PLATFORM),Darwin)
   cppflags+=-dynamiclib -undefined dynamic_lookup -Wno-delete-non-virtual-dtor
 endif
 
+# For these tests, the rootcling invocation looks like the following:
+# rootcling advancedcpp_rflx.cpp --rmf advancedcppDict.rootmap --rml advancedCppDict.so advancedcpp.h advancedcpp.xml
+%_rflx.cpp: %.h %.xml
+	rootcling $@ --rmf $*Dict.rootmap --rml $*Dict.so $^
+
+# Compiling the test dictionaries to shared libs:
+# g++ $(cppflags) -shared -o advancedcppDict.so advancedcpp_rflx.cpp advancedcpp.cxx
 %Dict.so: %_rflx.cpp %.cxx
 	$(CXX) $(cppflags) -shared -o $@ $^
 
-%_rflx.cpp: %.h %.xml
-	genreflex $< --selection=$*.xml --rootmap=$*Dict.rootmap --rootmap-lib=$*Dict.so
-
 .PHONY: test clean
 
 test:
-- 
2.43.0

